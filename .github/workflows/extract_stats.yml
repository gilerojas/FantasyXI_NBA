name: Extract Stats and Generate Highlights

permissions:
  contents: write

on:
  schedule:
    - cron: "0 10 * * *"  # 6:00 AM RD (UTC-4)
  workflow_dispatch:

jobs:
  extract_and_highlight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PERSONAL_PAT1 }}
      
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
      
      - name: Install project (editable)
        run: |
          source .venv/bin/activate
          pip install -e .
      
      - name: Extract daily stats
        env:
          ESPN_LEAGUE_ID: ${{ secrets.ESPN_LEAGUE_ID }}
          ESPN_S2: ${{ secrets.ESPN_S2 }}
          ESPN_SWID: ${{ secrets.ESPN_SWID }}
        run: |
          source .venv/bin/activate
          python src/fantasyxi/pipeline/extract_daily_stats.py
        continue-on-error: false
      
      - name: Generate highlights (opcional)
        run: |
          source .venv/bin/activate
          # python src/fantasyxi/analysis/highlight_top_performers.py
          echo "‚ö†Ô∏è Highlights script no implementado a√∫n"
      
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash
      
      - name: Decode rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 --decode > ~/.config/rclone/rclone.conf
      
      - name: Upload stats to Google Drive
        run: |
          FREEZE_DATE=$(jq -r '.date' data/processed/freeze_time.json)
          MONTH=${FREEZE_DATE:0:7}
          STATS_PATH="data/processed/daily_stats/$MONTH"
          
          # Verificar que el directorio existe
          if [ ! -d "$STATS_PATH" ]; then
            echo "‚ö†Ô∏è No hay stats para subir (directorio no existe: $STATS_PATH)"
            exit 0
          fi
          
          # Verificar que hay archivos CSV
          if [ -z "$(ls -A $STATS_PATH/*.csv 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è No hay archivos CSV para subir en $STATS_PATH"
            exit 0
          fi
          
          echo "üì§ Subiendo stats para $FREEZE_DATE..."
          rclone copy $STATS_PATH mallitalytics:FantasyXI/daily_stats/$MONTH/ --include "*$FREEZE_DATE*.csv" --quiet
          echo "‚úÖ Stats subidas exitosamente"
      
      - name: Commit stats
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Solo hacer commit si hay cambios
          if [ -n "$(git status --porcelain data/processed/daily_stats/)" ]; then
            git add data/processed/daily_stats/
            git commit -m "üìä Stats extra√≠das para $(jq -r '.date' data/processed/freeze_time.json)"
            git push
          else
            echo "No hay cambios en stats para commitear"
          fi